name: Universal CI (Maven & Gradle)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

concurrency:
  group: sonarqube-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          # We don't use 'cache' here because we use specific actions below

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # --- GRADLE LOGIC ---
      - name: Check for Gradle
        id: check_gradle
        run: |
          if [ -f "gradlew" ]; then echo "exists=true" >> $GITHUB_OUTPUT; fi

      - name: Setup Gradle & Cache
        if: steps.check_gradle.outputs.exists == 'true'
        uses: gradle/actions/setup-gradle@v4

      - name: Build and Analyze with Gradle
        if: steps.check_gradle.outputs.exists == 'true'
        run: ./gradlew build jacocoTestReport sonar --no-daemon
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_SCANNER_OPTS: "-Xmx512m" # Prevents OOM errors in CI

      # --- MAVEN LOGIC ---
      - name: Check for Maven
        id: check_maven
        run: |
          if [ -f "pom.xml" ]; then echo "exists=true" >> $GITHUB_OUTPUT; fi

      - name: Build and Analyze with Maven
        if: steps.check_maven.outputs.exists == 'true'
        # Maven's 'setup-java' or specialized actions handle caching automatically 
        # but for clarity, we use the standard 'mvn' command.
        run: mvn -B verify sonar:sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_SCANNER_OPTS: "-Xmx512m" # Prevents OOM errors in CI